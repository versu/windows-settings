# ユーザー環境変数PATH設定スクリプト仕様書

## 概要

PowerShellで作成された、WindowsのユーザーレベルのPATH環境変数に指定したディレクトリパスを追加するためのスクリプトです。パス存在確認、重複チェック、エラーハンドリング機能を備えた安全な環境変数管理ツールです。

## 機能一覧

### 主要機能

1. **PATH環境変数への追加**
   - 指定したディレクトリパスをユーザーレベルのPATH環境変数に追加
   - 既存のPATHを保持して新しいパスを追加

2. **パス存在確認**
   - 追加対象のディレクトリが実際に存在するかを事前チェック
   - 存在しないパスの場合はエラーで終了

3. **重複チェック機能**
   - 指定したパスが既にPATHに登録済みかを確認
   - 重複する場合は処理をスキップして安全に終了

### 補助機能

- 詳細なエラーメッセージ表示
- 色分けされたコンソール出力
- 処理結果の明確な通知
- 適切な終了コード設定

## パラメータ仕様

### 必須パラメータ

| パラメータ名 | 型 | 説明 |
|-------------|----|----|
| `PathToAdd` | string | PATH環境変数に追加するディレクトリのフルパス |

### パラメータ詳細

- **PathToAdd**
  - 必須パラメータ
  - ヘルプメッセージ: "追加するパスを指定してください"
  - 相対パス・絶対パス両方に対応
  - 存在チェックが自動実行される

## 使用方法

### 基本的な使用例

```powershell
# 基本的なパス追加
.\set-user-env.ps1 -PathToAdd "C:\MyTools\bin"

# 相対パスでの指定
.\set-user-env.ps1 -PathToAdd ".\tools"

# スペースを含むパスの指定
.\set-user-env.ps1 -PathToAdd "C:\Program Files\MyApp\bin"
```

### 実用的な使用例

```powershell
# Node.jsのグローバルパッケージパスを追加
.\set-user-env.ps1 -PathToAdd "C:\Users\username\AppData\Roaming\npm"

# Gitのbinディレクトリを追加
.\set-user-env.ps1 -PathToAdd "C:\Program Files\Git\bin"

# カスタムツールディレクトリを追加
.\set-user-env.ps1 -PathToAdd "C:\Users\username\Tools\bin"
```

## 実行結果例

### 成功時の出力

```powershell
PS> .\set-user-env.ps1 -PathToAdd "C:\MyTools\bin"
新しいPATH: C:\Users\username\AppData\Local\...;C:\MyTools\bin
パス 'C:\MyTools\bin' をユーザー環境変数PATHに追加しました。
```

### 重複パス検出時の出力

```powershell
PS> .\set-user-env.ps1 -PathToAdd "C:\Windows\System32"
パス 'C:\Windows\System32' は既にPATHに登録されています。
```

### エラー時の出力

```powershell
PS> .\set-user-env.ps1 -PathToAdd "C:\NonExistent\Path"
警告: 指定されたパス 'C:\NonExistent\Path' が存在しません。
```

## エラーハンドリング

### 検証項目

1. **パス存在確認**
   - `Test-Path`コマンドレットでディレクトリの存在をチェック
   - 存在しない場合は警告メッセージを表示して終了コード1で終了

2. **重複パス検出**
   - 現在のPATH環境変数を`;`で分割して配列化
   - `-contains`演算子で指定パスの重複をチェック
   - 重複する場合は情報メッセージを表示して終了コード0で正常終了

3. **環境変数更新**
   - `SetEnvironmentVariable`メソッドでユーザーレベルの環境変数を更新
   - システムレベルには影響しない安全な操作

### エラーメッセージと終了コード

| 状況 | メッセージ | 終了コード |
|------|-----------|----------|
| パス存在しない | `指定されたパス '[パス]' が存在しません。` | 1 |
| パス重複 | `パス '[パス]' は既にPATHに登録されています。` | 0 |
| 追加成功 | `パス '[パス]' をユーザー環境変数PATHに追加しました。` | 0 |

## 出力メッセージ

### 色分け仕様

- **緑色**: 成功メッセージ、追加完了通知
- **黄色**: 警告メッセージ、重複パス検出
- **赤色**: エラーメッセージ（警告含む）

## 必要な権限

### ユーザーレベル環境変数
- 特別な管理者権限は不要
- 現在のユーザーの環境変数のみを変更
- 通常のユーザー権限で実行可能

### 反映タイミング
- 環境変数の変更は即座に反映される
- 新しく起動するプロセスから新しいPATHが有効
- 既存の実行中プロセスには影響しない

## 対象環境

- **OS**: Windows 10/11
- **PowerShell**: バージョン 5.1以上
- **依存関係**: .NET Framework（Windows標準）

## 制限事項

1. **ユーザーレベル限定**
   - システムレベルのPATH環境変数は変更しない
   - 管理者権限での実行でもユーザーレベルのみ対象

2. **パス形式**
   - Windowsのパス区切り文字（`;`）を使用
   - UNCパス（`\\server\share\...`）も理論上対応だが非推奨

3. **文字制限**
   - PATH環境変数の最大長制限（約32KB）
   - 非常に長いパスの追加時は注意が必要

## セキュリティ考慮事項

1. **実行ポリシー**
   - PowerShellの実行ポリシーがRestrictedの場合は実行不可
   - 必要に応じて `Set-ExecutionPolicy` で変更が必要

2. **パス検証**
   - 信頼できないディレクトリをPATHに追加する際は注意
   - マルウェアが含まれる可能性のあるパスは避ける

3. **権限分離**
   - ユーザーレベルのみの変更により、システム全体への影響を最小限に抑制
   - 他のユーザーには影響しない安全な設計

## トラブルシューティング

### よくある問題

1. **環境変数が反映されない**
   - 新しいPowerShellセッションを開始してテスト
   - `$env:PATH -split ';'` で現在のPATHを確認

2. **パスが見つからないエラー**
   - フルパスで指定されているか確認
   - ディレクトリの存在とアクセス権限を確認

3. **重複パスの誤検出**
   - 大文字小文字の違いに注意
   - パス末尾の`\`の有無による差異に注意